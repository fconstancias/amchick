---
title: " beta-diversity "
author: "Florentin"
date: '`r format(Sys.time(), "%d %B, %Y")`'

output: 
  html_document: 
    toc: yes
    keep_md: yes
---
```{r setup, include=FALSE}
rm(list = ls()) # remove all the object before starting
knitr::opts_chunk$set(echo = TRUE)
```

#### Load required packages

```{r,packages,message=FALSE}
library(tidyverse)
library(phyloseq)
library(speedyseq)
library(ggrepel)
library(ampvis2)
library(plotly)
library(microbiome)
options(getClass.msg=FALSE) # https://github.com/epurdom/clusterExperiment/issues/66
#this fixes an error message that pops up because the class 'Annotated' is defined in two different packages
```

#### Load functions from Github

```{r}
'%!in%' <- function(x,y)!('%in%'(x,y))

source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_taxa_tests.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_normalisation.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_alpha.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_beta.R")
source("https://raw.githubusercontent.com/fconstancias/DivComAnalyses/master/R/phyloseq_heatmap.R")
```


#### Load physeq object


```{r}
ps = "data/processed/physeq_update_23_11.RDS"

ps %>% 
  here::here() %>%
  readRDS() %>%
  phyloseq_get_strains_fast() %>%
  phyloseq_remove_chloro_mitho() -> physeq



physeq %>% 
  subset_samples(Experiment == "Continuous") %>% 
  subset_samples(Paul %!in% c("Paul")) %>%
  subset_samples(Reactor != "IR2") -> ps_PolyFermS

```  

We will be analysing only the PolyFermS samples here so take a subset of the physeq object.  
```{r}
physeq %>% 
  subset_samples(Experiment == "Continuous") %>% 
  subset_samples(Paul %!in% c("Paul")) %>%
  subset_samples(Reactor != "IR2") -> ps_polyFermS

sample_data(ps_polyFermS)$Reactor <- fct_relevel(sample_data(ps_polyFermS)$Reactor, "IR1", "CR", "TR1", "TR2","TR3", "TR4", "TR5", "TR6") 

sample_data(ps_polyFermS)$Treatment <- fct_relevel(sample_data(ps_polyFermS)$Treatment, "UNTREATED",  "CTX+HV292.1", "CTX","HV292.1","VAN+CCUG59168", "VAN",  "CCUG59168") 

sample_data(ps_polyFermS)$Reactor_Treatment <- fct_relevel(sample_data(ps_polyFermS)$Reactor_Treatment, "IR1_UNTREATED","CR_UNTREATED", "CR_CTX", "CR_VAN", "TR1_CTX+HV292.1","TR2_CTX", "TR3_HV292.1", "TR5_VAN+CCUG59168", "TR4_VAN", "TR6_CCUG59168") 

ps_polyFermS %>% 
  rarefy_even_depth(sample.size = 4576,
                    rngseed = 123) -> ps_polyFermS_rare
```

Compute beta-div metrics:

```{r}
ps_polyFermS_rare %>%
  phyloseq_compute_bdiv(norm = "pc",
                        phylo = TRUE,
                        seed = 123) -> bdiv_list
```


```{r,fig.align="center", warning = FALSE, message = FALSE, results = FALSE}
ps_polyFermS_rare  %>%
  subset_samples(Enrichment == "NotEnriched") %>%
  phyloseq_plot_bdiv(bdiv_list,
                     m = "CoDa",
                     seed = 123) -> coda
  
coda$PCA$layers[[1]] = NULL

coda$PCA + geom_point(size=2,
                   aes(color = Reactor, 
                       fill = Treatment2,
                       shape = Reactor_Treatment,
                       alpha = Day_from_Inoculum)) + 
  theme_light() +
  geom_path(arrow = arrow(type = "open", angle = 30, length = unit(0.15, "inches")),
              size = 0.08, linetype = "dashed", inherit.aes = TRUE, aes(group=Reactor, color = Reactor)) +
  scale_alpha_continuous(range=c( 0.9, 0.3)) + scale_color_viridis_d(na.value = "black") + 
  scale_fill_viridis_d(na.value = "black") + 
  scale_shape_manual(values = c(8, 21, 22, 23, 24, 16, 15, 18, 17)) + 
  theme_classic() -> p1

p1
```

```{r,fig.align="center", warning = FALSE, message = FALSE, results = FALSE}
p1 %>%
  ggplotly(tooltip = c("Reactor_Treatment", "Day_from_Inoculum"))
```

Visualize distance 'trajectories' :
For each distance generate X,Y plots of reactor's distance to 'previous'/ 'Day_-1'.
Facet the plot according to the different treatments (DSS, predni, eu..., dis...) 

```{r,fig.align="center"}
coda$physeq_clr %>% 
  otu_table() %>%
  vegan::vegdist(method = "eucl") %>%
  as.matrix() -> mtest

var="Reactor"

ps_polyFermS_rare  %>%
  subset_samples(Enrichment == "NotEnriched") -> phylo_tmp

for(gp in phylo_tmp %>% 
  get_variable(var) %>%
  levels())
{
print(gp)

tmp <- prune_samples(get_variable(phylo_tmp, var) == gp,
                     phylo_tmp)

if (nsamples(tmp) >= 2)
{
  
tmp %>%
  sample_data() %>%
  rownames_to_column("SampleID") %>%
  data.frame() -> tmp2
  #drop_na() 


left_join(
  reshape2::melt(mtest[sample_names(tmp),sample_names(tmp)], 
               varnames = c("Sample1", "Sample2"), 
               value.name = "distance") %>% 
  filter(distance != 0 ),
  tmp2,
  by = c("Sample1" = "SampleID"),
  suffix = c("", ".y")
  ) %>%
  as_tibble() %>%
    dplyr::rename(Day1 = Day_from_Inoculum) %>%
  left_join(
   tmp2,
  by = c("Sample2" = "SampleID")
  )  %>%
   as_tibble() %>%
    dplyr::rename(Day2 = Day_from_Inoculum) %>%
  select(starts_with("Samp"), starts_with("Day"), distance, -ends_with(".y")) %>%
  arrange(Day1, Day2) %>%
  mutate(Days = paste0(Day1,"_", Day2)) -> tmp3 #%>%
  # dplyr::rename(treatment = treatment.x, mouse_label = mouse_label.x) -> tmp3

tmp3 %>% 
  filter(Day2>Day1) %>%
  ggplot(aes(x = as.factor(Day2) , y = distance)) +
  geom_point(size=1, alpha=0.6, aes(colour = Reactor, group=Reactor),
            position=position_jitterdodge(dodge.width=0.9)) + 
  geom_path(arrow = arrow(type = "open", angle = 30, length = unit(0.1, "inches")),
              size = 0.4, linetype = "dashed", inherit.aes = TRUE, aes(group=Reactor, color = Reactor),
            position=position_jitterdodge(dodge.width=0.9)) +
  geom_boxplot(aes(group = Day2 %>% as.factor()),
               fill = "transparent",
               outlier.colour = NA,alpha=0.4) +
  facet_grid(. ~ Reactor, scales = "free_y") +
      ggrepel::geom_text_repel(cex=2,
                           aes(label= mouse_label),
                           segment.color = 'black',
                           segment.size = 0.5,
                           # nudge_x =  -4,
                           # nudge_y = 0,
                           df_all_t0 %>% filter(Day2 == 6 & metric=="wunifrac") %>% unique()) +
  theme_bw() + xlab("Day") + ylab("Distance to day-1") +
  geom_vline(xintercept = 0, colour="red", linetype = "dotted", size = 0.2) + 
  theme(legend.position = "none") ->tmp

print(tmp)


tmp3 %>%
  filter(Day1 %in% c("2")) %>%
  mutate(metric = i) -> tmp4

bind_rows(tmp4, 
          df_all_t0) -> df_all_t0

# bind_rows(
# tmp3 %>%
#   filter(Day1 %in% c("Day_-1") & Day2 %in% c("Day_6")),
# tmp3 %>%
#   filter(Day1 %in% c("Day_6") & Day2 %in% c("Day_12")),
# tmp3 %>%
#   filter(Day1 %in% c("Day_12") & Day2 %in% c("Day_14"))
# ) %>%
#   mutate(metric = i) -> tmp5
# 
# bind_rows(tmp5,
#             df_all_tprev) -> df_all_tprev

}else{
# paste0(nsamples(tmp)," samples for mice : ", mice, " : not enough") %>%
#     print()
  }
}


```

```{r}
plot_alpha_time <- function(df, 
                            x = "Day_from_Inoculum", 
                            y = "value", 
                            group = "Reactor_Treatment", 
                            facet)
{
  df %>%
  arrange(Day_from_Inoculum) %>%
  ggplot(aes_string(x = x,
             y = y)) +
  geom_point(size=2, alpha=0.9, aes_string(group = group)) + 
  geom_path(inherit.aes = TRUE, aes_string(group=group),
            size = 0.08,
            linetype = "dashed") +
  facet_grid(as.formula(facet), scales = "free") +
  theme_light() +
  ylab("alpha-diversity") +
  scale_color_viridis_d(na.value = "black") + 
  geom_vline(xintercept = c(23,39), 
             color="black", alpha=0.4) + 
  geom_smooth(show.legend = TRUE, level = 0.95) + 
  scale_x_continuous(breaks=seq(0,90,10)) -> plot

  return(plot)
}

```

```{r,fig.height=6, fig.width=10}
out$plot$data %>%
  dplyr::filter(Reactor %in% c("IR1", "CR")) %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("Observed")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p1

out$plot$data %>%
  dplyr::filter(Reactor %in% c("IR1", "CR")) %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("diversity_shannon")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p2


out$plot$data %>%
  dplyr::filter(Reactor %in% c("IR1", "CR")) %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("evenness_pielou")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p3

ggpubr::ggarrange(p1 + ylab(NULL) + xlab(NULL),p2 + ylab(NULL) + xlab(NULL) ,p3+ ylab(NULL) + xlab(NULL),
                  ncol = 3,
                  nrow = 1,
                  common.legend = TRUE) -> bigp_1

 bigp_1
```

```{r,fig.height=10, fig.width=18}
out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  plot_alpha_time(facet = c("alphadiversiy ~ Reactor_Treatment")) -> p4

p4
```

```{r,fig.height=10, fig.width=18}
out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("Observed")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p5

out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("diversity_shannon")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p6


out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("evenness_pielou")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p7

out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("SES.MPD")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed")  -> p8

out$plot$data %>%
  dplyr::filter(Enrichment == "NotEnriched") %>%
  dplyr::filter(alphadiversiy %in% c("bNTI")) %>% 
  plot_alpha_time(facet = c("Reactor_Treatment ~ alphadiversiy")) + 
  facet_null() + 
  facet_grid(Reactor_Treatment~ alphadiversiy, scales = "fixed") -> p9

ggpubr::ggarrange(p5 + ylab(NULL) + xlab(NULL),
                  p6 + ylab(NULL)+ xlab(NULL),
                  p7 + ylab(NULL)+ xlab(NULL),
                  p8 + ylab(NULL)+ xlab(NULL),
                  p9 + ylab(NULL)+ xlab(NULL),
                  ncol = 5,
                  nrow = 1,
                  common.legend = TRUE) -> bigp_2

bigp_2
```

```{r}
paste0(here::here(),
       "/data/processed/",
       "alpha",
       "_",
       format(Sys.time(), "%Y%b%d")
       ,".RData") %>% save.image()
# load("/Users/fconstan/Projects/EZe/ASV/260420.RData")
```

```{r}
sessionInfo()
```

